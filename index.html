<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JingLun AI - ç»çº¶é€šè¯†</title>
  <style>
    :root {
      --primary-color: #722F37;
      --secondary-color: #A4373A;
      --light-color: #F5F1E6;
      --dark-color: #333333;
      --border-color: #D9C8A9;
      --highlight-color: #DAA520;
      --text-color: #333333;
      --light-text: #F5F1E6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", "SimSun", "STKaiti", sans-serif;
    }

    body {
      background-color: var(--light-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¯¼èˆªæ æ ·å¼ */
    .navbar {
      background-color: var(--primary-color);
      color: var(--light-text);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      background-color: var(--light-text);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--primary-color);
      font-size: 20px;
    }

    .logo-text {
      font-size: 1.5em;
      font-weight: bold;
    }

    .user-settings {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--light-text);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-weight: bold;
    }

    .setting-icon {
      cursor: pointer;
    }

    /* ä¸»å†…å®¹åŒºæ ·å¼ */
    .main-container {
      display: flex;
      flex: 1;
      height: calc(100vh - 60px);
    }

    /* å·¦ä¾§å†…å®¹åŒº - 70% */
    .content-area {
      width: 70%;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: calc(100vh - 60px);
      overflow-y: auto;
    }

    /* å³ä¾§èŠå¤©åŒº - 30% */
    .chat-area {
      width: 30%;
      background-color: white;
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      position: sticky;
      top: 60px;
    }

    /* è¾“å…¥åŒºæ ·å¼ */
    .input-section {
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .input-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .input-tabs {
      display: flex;
      gap: 10px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      font-weight: bold;
      color: var(--text-color);
      background-color: transparent;
      border: none;
      outline: none;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }

    textarea {
      width: 100%;
      height: 120px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      font-size: 16px;
      resize: none;
      outline: none;
      transition: border-color 0.3s;
    }

    textarea:focus {
      border-color: var(--primary-color);
    }

    .input-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-upload {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .upload-btn {
      background-color: transparent;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .submit-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .submit-btn:hover {
      background-color: var(--secondary-color);
    }

    .submit-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* åŸæ–‡å±•ç¤ºåŒºæ ·å¼ */
    .original-text-section {
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .section-title {
      font-size: 1.2em;
      color: var(--primary-color);
      margin-bottom: 15px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-icon {
      font-size: 20px;
    }

    .text-paragraphs {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .paragraph {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      background-color: rgba(245, 241, 230, 0.3);
    }

    .original {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 15px;
      font-family: "STKaiti", "KaiTi", serif;
    }

    .translation {
      font-size: 16px;
      line-height: 1.5;
      color: #555;
      margin-bottom: 15px;
      border-top: 1px dashed var(--border-color);
      padding-top: 15px;
    }

    .notes {
      font-size: 14px;
      line-height: 1.5;
      color: #666;
      background-color: rgba(218, 165, 32, 0.1);
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid var(--highlight-color);
    }

    /* æ·±åº¦è§£æåŒºæ ·å¼ */
    .analysis-section {
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .analysis-tab {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px;
      background-color: #f5f5f5;
      border: none;
      outline: none;
      font-size: 14px;
    }

    .analysis-tab.active {
      background-color: var(--primary-color);
      color: white;
    }

    .analysis-content {
      line-height: 1.6;
      font-size: 16px;
    }

    /* ç°ä»£åº”ç”¨åŒºæ ·å¼ */
    .modern-application {
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .application-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .application-tab {
      background-color: transparent;
      border: none;
      padding: 5px 0;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-color);
      position: relative;
    }

    .application-tab.active {
      color: var(--primary-color);
      font-weight: bold;
    }

    .application-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: var(--primary-color);
    }

    .application-content {
      line-height: 1.6;
      font-size: 16px;
    }

    /* èŠå¤©åŒºæ ·å¼ */
    .chat-header {
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: calc(100% - 120px);
    }

    .message {
      max-width: 85%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.4;
      font-size: 15px;
      position: relative;
    }

    .user-message {
      background-color: #e2f4ff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .ai-message {
      background-color: #f1f1f1;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    /* èŠå¤©è¾“å…¥åŒºæ ·å¼ */
    .chat-input {
      padding: 15px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      background-color: white;
      position: sticky;
      bottom: 0;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      outline: none;
      font-size: 15px;
    }

    .send-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .send-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* APIé…ç½®å¼¹çª— */
    .api-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .api-modal.show {
      display: flex;
    }

    .api-modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    .api-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .api-form label {
      font-weight: bold;
    }

    .api-form input {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }

    .api-form button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 1200px) {
      .main-container {
        flex-direction: column;
      }

      .content-area,
      .chat-area {
        width: 100%;
        height: auto;
      }

      .content-area {
        height: auto;
        max-height: none;
      }

      .chat-area {
        height: 400px;
        border-left: none;
        border-top: 1px solid var(--border-color);
        position: relative;
        top: 0;
      }

      .chat-messages {
        max-height: 280px;
      }
    }
  </style>
</head>

<body>
  <!-- APIé…ç½®å¼¹çª— -->
  <div id="apiModal" class="api-modal">
    <div class="api-modal-content">
      <div class="modal-header">
        <h3>APIé…ç½®</h3>
        <button class="close-btn" onclick="closeApiModal()">&times;</button>
      </div>
      <form class="api-form" onsubmit="saveApiConfig(event)">
        <label for="apiKey">DeepSeek API Key:</label>
        <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„DeepSeek API Key" required>
        <label for="apiUrl">APIåœ°å€:</label>
        <input type="url" id="apiUrl" value="https://api.deepseek.com/v1/chat/completions" required>
        <button type="submit">ä¿å­˜é…ç½®</button>
      </form>
    </div>
  </div>

  <!-- å¯¼èˆªæ  -->
  <div class="navbar">
    <div class="logo">
      <div class="logo-img">ç»</div>
      <div class="logo-text">JingLun AIï¼ˆç»çº¶é€šè¯†ï¼‰</div>
    </div>
    <div class="user-settings">
      <div class="setting-icon" onclick="openApiModal()">âš™ï¸</div>
      <div class="user-avatar">æ¸¸</div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="main-container">
    <!-- å·¦ä¾§å†…å®¹åŒº - 70% -->
    <div class="content-area">
      <!-- è¾“å…¥åŒº -->
      <div class="input-section">
        <div class="input-container">
          <div class="input-tabs">
            <button class="tab active">æ–‡æœ¬è¾“å…¥</button>
            <button class="tab">OCRä¸Šä¼ </button>
          </div>
          <textarea id="textInput" placeholder="è¯·è¾“å…¥å¤æ–‡æ–‡æœ¬ï¼Œæˆ–ç²˜è´´éœ€è¦æ ¡å¯¹/è§£æçš„å†…å®¹..."></textarea>
          <div class="input-actions">
            <div class="file-upload">
              <button class="upload-btn">
                <span>ğŸ“„</span> ä¸Šä¼ æ–‡ä»¶
              </button>
              <button class="upload-btn">
                <span>ğŸ“¸</span> ä¸Šä¼ å›¾ç‰‡
              </button>
            </div>
            <button class="submit-btn" id="submitBtn" onclick="analyzeText()">å¼€å§‹è§£æ</button>
          </div>
        </div>
      </div>

      <!-- åŸæ–‡å±•ç¤ºåŒº -->
      <div class="original-text-section" id="originalSection" style="display: none;">
        <div class="section-title">
          <span class="section-icon">ğŸ“œ</span> åŸæ–‡æ ¡å¯¹ä¸ç¿»è¯‘
        </div>
        <div class="text-paragraphs" id="textParagraphs">
          <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
        </div>
      </div>

      <!-- æ·±åº¦è§£æåŒº -->
      <div class="analysis-section" id="analysisSection" style="display: none;">
        <div class="section-title">
          <span class="section-icon">ğŸ”</span> æ·±åº¦è§£æ
        </div>
        <div class="tabs">
          <button class="analysis-tab active" data-tab="æ€æƒ³å†…æ¶µ">æ€æƒ³å†…æ¶µ</button>
          <button class="analysis-tab" data-tab="æ–‡åŒ–èƒŒæ™¯">æ–‡åŒ–èƒŒæ™¯</button>
          <button class="analysis-tab" data-tab="å…¸æ•…å…³è”">å…¸æ•…å…³è”</button>
          <button class="analysis-tab" data-tab="ç‰ˆæœ¬å¯¹æ¯”">ç‰ˆæœ¬å¯¹æ¯”</button>
        </div>
        <div class="analysis-content" id="analysisContent">
          <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
        </div>
      </div>

      <!-- ç°ä»£åº”ç”¨åŒº -->
      <div class="modern-application" id="applicationSection" style="display: none;">
        <div class="section-title">
          <span class="section-icon">ğŸ”„</span> ç°ä»£åº”ç”¨
        </div>
        <div class="application-tabs">
          <button class="application-tab active" data-tab="ç°å®æ¡ˆä¾‹">ç°å®æ¡ˆä¾‹</button>
          <button class="application-tab" data-tab="å¯ç¤ºå€Ÿé‰´">å¯ç¤ºå€Ÿé‰´</button>
        </div>
        <div class="application-content" id="applicationContent">
          <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
        </div>
      </div>
    </div>

    <!-- å³ä¾§èŠå¤©åŒº - 30% -->
    <div class="chat-area">
      <div class="chat-header">
        ç»çº¶é€šè¯†åŠ©æ‰‹
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message ai-message">
          æ¬¢è¿ä½¿ç”¨ç»çº¶é€šè¯†AIåŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®æ‚¨è§£æå¤æ–‡ã€å‡ºå¤„è€ƒè¯ã€æ–‡åŒ–é˜é‡Šç­‰ã€‚æ‚¨å¯ä»¥åœ¨å·¦ä¾§è¾“å…¥æ–‡æœ¬ï¼Œæˆ–ç›´æ¥åœ¨è¿™é‡Œå‘æˆ‘æé—®ã€‚<br><br>
          <strong>ä½¿ç”¨æç¤ºï¼š</strong><br>
          1. ç‚¹å‡»å³ä¸Šè§’âš™ï¸é…ç½®DeepSeek API<br>
          2. åœ¨å·¦ä¾§è¾“å…¥å¤æ–‡è¿›è¡Œå…¨é¢è§£æ<br>
          3. æˆ–åœ¨æ­¤å¤„ç›´æ¥æé—®äº¤æµ
        </div>
      </div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
        <button class="send-btn" id="sendBtn" onclick="sendChatMessage()">â¤</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let apiConfig = {
      apiKey: '',
      apiUrl: 'https://api.deepseek.com/v1/chat/completions'
    };

    let analysisData = {};
    let applicationData = {};

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      loadApiConfig();
      setupEventListeners();
    });

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // è¾“å…¥æ ‡ç­¾åˆ‡æ¢
      const inputTabs = document.querySelectorAll('.input-tabs .tab');
      inputTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          inputTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        });
      });

      // è§£ææ ‡ç­¾åˆ‡æ¢
      const analysisTabs = document.querySelectorAll('.analysis-tab');
      analysisTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          analysisTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          showAnalysisContent(tab.dataset.tab);
        });
      });

      // åº”ç”¨æ ‡ç­¾åˆ‡æ¢
      const applicationTabs = document.querySelectorAll('.application-tab');
      applicationTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          applicationTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          showApplicationContent(tab.dataset.tab);
        });
      });

      // èŠå¤©è¾“å…¥å›è½¦å‘é€
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendChatMessage();
          e.preventDefault();
        }
      });
    }

    // APIé…ç½®ç›¸å…³å‡½æ•°
    function openApiModal() {
      document.getElementById('apiModal').classList.add('show');
      if (apiConfig.apiKey) {
        document.getElementById('apiKey').value = apiConfig.apiKey;
      }
      document.getElementById('apiUrl').value = apiConfig.apiUrl;
    }

    function closeApiModal() {
      document.getElementById('apiModal').classList.remove('show');
    }

    

    function saveApiConfig(event) {
      event.preventDefault();
      apiConfig.apiKey = document.getElementById('apiKey').value;
      apiConfig.apiUrl = document.getElementById('apiUrl').value;

      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      const configData = {
        apiKey: apiConfig.apiKey,
        apiUrl: apiConfig.apiUrl
      };
      // å®é™…ä¸Šä¿å­˜åˆ° localStorage
      localStorage.setItem('deepseekApiConfig', JSON.stringify(configData)); // <-- åœ¨è¿™é‡Œæ·»åŠ äº†ä¿å­˜åˆ°localStorageçš„é€»è¾‘

      closeApiModal();
      alert('APIé…ç½®å·²ä¿å­˜ï¼');
    }

    function loadApiConfig() {
      // åœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥ä»localStorageåŠ è½½
      // è¿™é‡Œä¸ºäº†æ¼”ç¤ºç›®çš„ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
      // å°è¯•ä»localStorageåŠ è½½ä¹‹å‰ä¿å­˜çš„é…ç½®
      const storedConfig = localStorage.getItem('deepseekApiConfig');
      if (storedConfig) {
        try {
          const parsedConfig = JSON.parse(storedConfig);
          apiConfig.apiKey = parsedConfig.apiKey || '';
          apiConfig.apiUrl = parsedConfig.apiUrl || 'https://api.deepseek.com/v1/chat/completions';
          console.log("APIé…ç½®å·²ä»localStorageåŠ è½½ã€‚");
        } catch (e) {
          console.error("è§£ælocalStorageä¸­çš„APIé…ç½®å¤±è´¥:", e);
          // å¦‚æœè§£æå¤±è´¥ï¼Œå›é€€åˆ°é»˜è®¤å€¼
          setDefaultApiKey();
        }
      } else {
        // å¦‚æœlocalStorageä¸­æ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼
        setDefaultApiKey();
      }
    }

    // è®¾ç½®é»˜è®¤API Keyçš„è¾…åŠ©å‡½æ•°
    function setDefaultApiKey() {
      // !!! è­¦å‘Šï¼šå°†API Keyç›´æ¥æ”¾å…¥å‰ç«¯ä»£ç ä¸­å­˜åœ¨å®‰å…¨é£é™©ã€‚
      // !!! ä»…ç”¨äºä¸ªäººæµ‹è¯•æˆ–å¼€å‘ç¯å¢ƒã€‚ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨åç«¯ä»£ç†ã€‚
      apiConfig.apiKey = 'sk-6b732d64cf7f440491f187fa82e89a2d'; // <--- å°†æ­¤å¤„æ›¿æ¢ä¸ºä½ çš„é»˜è®¤API Key
      apiConfig.apiUrl = 'https://api.deepseek.com/v1/chat/completions';
      console.log("APIé…ç½®å·²è®¾ç½®ä¸ºé»˜è®¤å€¼ã€‚");
    }

    // DeepSeek APIè°ƒç”¨å‡½æ•° - æ”¯æŒæµå¼è¾“å‡º
    async function callDeepSeekAPI(messages, systemPrompt = '', streaming = false, onChunk = null) {
      if (!apiConfig.apiKey) {
        throw new Error('è¯·å…ˆé…ç½®DeepSeek API Key');
      }

      const requestBody = {
        model: "deepseek-chat",
        messages: [
          ...(systemPrompt ? [{ role: "system", content: systemPrompt }] : []),
          ...messages
        ],
        temperature: 0.7,
        max_tokens: 4000,
        stream: streaming
      };

      try {
        const response = await fetch(apiConfig.apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiConfig.apiKey}`
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }

        if (streaming) {
          return await handleStreamingResponse(response, onChunk);
        } else {
          const data = await response.json();
          return data.choices[0].message.content;
        }
      } catch (error) {
        console.error('APIè°ƒç”¨é”™è¯¯:', error);
        throw error;
      }
    }

    // å¤„ç†æµå¼å“åº”
    async function handleStreamingResponse(response, onChunk) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullContent = '';

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6).trim();
              if (data === '[DONE]') {
                return fullContent;
              }

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices?.[0]?.delta?.content;
                if (content) {
                  fullContent += content;
                  if (onChunk) {
                    onChunk(content);
                  }
                }
              } catch (e) {
                // å¿½ç•¥JSONè§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
              }
            }
          }
        }
      } finally {
        reader.releaseLock();
      }

      return fullContent;
    }

    // èŠå¤©åŠŸèƒ½ - æ”¯æŒæµå¼è¾“å‡º
    async function sendChatMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();

      if (!message) return;

      if (!apiConfig.apiKey) {
        alert('è¯·å…ˆé…ç½®DeepSeek API Key');
        openApiModal();
        return;
      }

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addChatMessage(message, 'user');
      chatInput.value = '';

      // ç¦ç”¨å‘é€æŒ‰é’®
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<div class="loading"></div>';

      // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
      const aiMessageDiv = createAIMessage();

      try {
        const systemPrompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å¤æ–‡ç ”ç©¶ä¸“å®¶å’Œæ–‡åŒ–å­¦è€…ï¼Œä¸“é—¨ç ”ç©¶ä¸­å›½å¤å…¸æ–‡å­¦ã€å“²å­¦å’Œæ–‡åŒ–ã€‚è¯·ç”¨ä¸“ä¸šè€Œé€šä¿—æ˜“æ‡‚çš„æ–¹å¼å›ç­”ç”¨æˆ·å…³äºå¤æ–‡ã€å¤å…¸æ–‡åŒ–ã€å†å²å…¸æ•…ç­‰æ–¹é¢çš„é—®é¢˜ã€‚å›ç­”è¦å‡†ç¡®ã€è¯¦ç»†ï¼Œå¹¶å°½å¯èƒ½ç»“åˆç°ä»£ç”Ÿæ´»è¿›è¡Œé˜é‡Šã€‚`;

        // è·å–æœ€è¿‘å‡ æ¡èŠå¤©è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
        const chatMessages = getChatHistory();

        // æµå¼è¾“å‡ºå›è°ƒå‡½æ•°
        const onChunk = (content) => {
          aiMessageDiv.innerHTML += content.replace(/\n/g, '<br>');
          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          const chatMessagesContainer = document.getElementById('chatMessages');
          chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        };

        await callDeepSeekAPI([
          ...chatMessages,
          { role: "user", content: message }
        ], systemPrompt, true, onChunk);

      } catch (error) {
        console.error('èŠå¤©é”™è¯¯:', error);
        aiMessageDiv.innerHTML = `æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š${error.message}`;
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = 'â¤';
      }
    }

    // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
    function createAIMessage() {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai-message';
      messageDiv.innerHTML = ''; // å¼€å§‹æ—¶ä¸ºç©º

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return messageDiv;
    }
    // æ–‡æœ¬è§£æå‡½æ•°
    async function analyzeText() {
      const textInput = document.getElementById('textInput').value.trim();
      if (!textInput) {
        alert('è¯·è¾“å…¥è¦è§£æçš„å¤æ–‡æ–‡æœ¬');
        return;
      }

      if (!apiConfig.apiKey) {
        alert('è¯·å…ˆé…ç½®DeepSeek API Key');
        openApiModal();
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> è§£æä¸­...';

      try {
        const systemPrompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å¤æ–‡ç ”ç©¶ä¸“å®¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å¯¹å¤æ–‡è¿›è¡Œè¯¦ç»†è§£æï¼š
æ³¨æ„ï¼šæ‰€è¾“å…¥å¤æ–‡å¯èƒ½å­˜åœ¨é”™åˆ«å­—ï¼Œæ•…ä½ åº”è¯¥å…ˆåœ¨å·²çŸ¥å¤è¯—æ–‡ä¸­å¯»æ‰¾ä¸æ‰€è¾“å…¥å¤æ–‡ç›¸ä¼¼åº¦æœ€é«˜çš„åŸæ–‡ï¼Œå¹¶å†™åœ¨ä¸‹é¢çš„åŸå§‹æ–‡æœ¬å¤„ï¼Œåç»­å†…å®¹éƒ½åŸºäºåŸå§‹æ–‡æœ¬è¿›è¡Œè§£æã€‚
{
  "åŸæ–‡æ ¡å¯¹": {
    "æ®µè½": [
      {
        "åŸæ–‡": "åŸå§‹æ–‡æœ¬",
        "ç¿»è¯‘": "ç°ä»£æ±‰è¯­ç¿»è¯‘", 
        "æ ¡å¯¹è¯´æ˜": "å­—è¯æ ¡å¯¹ã€é€šå‡å­—è¯´æ˜ç­‰"
      }
    ]
  },
  "æ·±åº¦è§£æ": {
    "æ€æƒ³å†…æ¶µ": "è¯¦ç»†é˜è¿°æ–‡æœ¬çš„æ€æƒ³å†…å®¹å’Œå“²å­¦æ„è•´",
    "æ–‡åŒ–èƒŒæ™¯": "ä»‹ç»æ–‡æœ¬çš„å†å²æ–‡åŒ–èƒŒæ™¯å’Œæ—¶ä»£ç‰¹è‰²",
    "å…¸æ•…å…³è”": "ç›¸å…³å…¸æ•…ã€å¼•ç”¨æ¥æºå’Œæ–‡çŒ®å…³è”",
    "ç‰ˆæœ¬å¯¹æ¯”": "ä¸åŒç‰ˆæœ¬çš„å·®å¼‚å’Œæ ¡å‹˜è¯´æ˜"
  },
  "ç°ä»£åº”ç”¨": {
    "ç°å®æ¡ˆä¾‹": "ç»“åˆç°ä»£ç¤¾ä¼šçš„å…·ä½“åº”ç”¨æ¡ˆä¾‹",
    "å¯ç¤ºå€Ÿé‰´": "å¯¹ç°ä»£äººçš„å¯å‘å’Œå€Ÿé‰´æ„ä¹‰"
  }
}

è¯·ç¡®ä¿å›å¤ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°JSONæ ¼å¼ï¼Œå†…å®¹è¦è¯¦å®å‡†ç¡®ï¼Œä½“ç°ä¸“ä¸šæ°´å‡†ã€‚`;

        const response = await callDeepSeekAPI([
          { role: "user", content: `è¯·è§£æä»¥ä¸‹å¤æ–‡ï¼š\n\n${textInput}` }
        ], systemPrompt);

        // è§£æJSONå“åº”
        let parsedData;
        try {
          // æå–JSONéƒ¨åˆ†ï¼ˆå¦‚æœå“åº”åŒ…å«å…¶ä»–æ–‡æœ¬ï¼‰
          const jsonMatch = response.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            parsedData = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('æ— æ³•è§£æAPIå“åº”ä¸ºJSONæ ¼å¼');
          }
        } catch (parseError) {
          console.error('JSONè§£æé”™è¯¯:', parseError);
          // å¦‚æœJSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å“åº”
          showSimpleAnalysis(response);
          return;
        }

        // æ¸²æŸ“è§£æç»“æœ
        renderAnalysisResults(parsedData);

      } catch (error) {
        console.error('è§£æé”™è¯¯:', error);
        alert(`è§£æå¤±è´¥: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'å¼€å§‹è§£æ';
      }
    }

    // æ¸²æŸ“è§£æç»“æœ
    function renderAnalysisResults(data) {
      // æ¸²æŸ“åŸæ–‡æ ¡å¯¹ä¸ç¿»è¯‘
      if (data.åŸæ–‡æ ¡å¯¹ && data.åŸæ–‡æ ¡å¯¹.æ®µè½) {
        renderOriginalText(data.åŸæ–‡æ ¡å¯¹.æ®µè½);
      }

      // ä¿å­˜æ·±åº¦è§£ææ•°æ®
      if (data.æ·±åº¦è§£æ) {
        analysisData = data.æ·±åº¦è§£æ;
        renderAnalysisSection();
      }

      // ä¿å­˜ç°ä»£åº”ç”¨æ•°æ®
      if (data.ç°ä»£åº”ç”¨) {
        applicationData = data.ç°ä»£åº”ç”¨;
        renderApplicationSection();
      }

      // æ˜¾ç¤ºæ‰€æœ‰åŒºåŸŸ
      document.getElementById('originalSection').style.display = 'block';
      document.getElementById('analysisSection').style.display = 'block';
      document.getElementById('applicationSection').style.display = 'block';
    }

    // æ¸²æŸ“åŸæ–‡åŒºåŸŸ
    function renderOriginalText(paragraphs) {
      const container = document.getElementById('textParagraphs');
      container.innerHTML = '';

      paragraphs.forEach(para => {
        const paragraphDiv = document.createElement('div');
        paragraphDiv.className = 'paragraph';

        paragraphDiv.innerHTML = `
          <div class="original">${para.åŸæ–‡ || ''}</div>
          <div class="translation">${para.ç¿»è¯‘ || ''}</div>
          <div class="notes">ã€æ ¡å¯¹è¯´æ˜ã€‘${para.æ ¡å¯¹è¯´æ˜ || 'æš‚æ— æ ¡å¯¹è¯´æ˜'}</div>
        `;

        container.appendChild(paragraphDiv);
      });
    }

    // æ¸²æŸ“æ·±åº¦è§£æåŒºåŸŸ
    function renderAnalysisSection() {
      showAnalysisContent('æ€æƒ³å†…æ¶µ');
    }

    function showAnalysisContent(tabName) {
      const content = analysisData[tabName] || 'æš‚æ— ç›¸å…³å†…å®¹';
      const contentElement = document.getElementById('analysisContent');
      contentElement.innerHTML = `<p>${content.replace(/\n/g, '</p><p>')}</p>`;
    }

    // æ¸²æŸ“ç°ä»£åº”ç”¨åŒºåŸŸ
    function renderApplicationSection() {
      showApplicationContent('ç°å®æ¡ˆä¾‹');
    }

    function showApplicationContent(tabName) {
      const content = applicationData[tabName] || 'æš‚æ— ç›¸å…³å†…å®¹';
      const contentElement = document.getElementById('applicationContent');
      contentElement.innerHTML = `<p>${content.replace(/\n/g, '</p><p>')}</p>`;
    }

    // ç®€å•è§£ææ˜¾ç¤ºï¼ˆå½“JSONè§£æå¤±è´¥æ—¶ï¼‰
    function showSimpleAnalysis(response) {
      // æ˜¾ç¤ºåŸæ–‡åŒºåŸŸï¼ˆä½¿ç”¨è¾“å…¥çš„æ–‡æœ¬ï¼‰
      const textInput = document.getElementById('textInput').value.trim();
      document.getElementById('textParagraphs').innerHTML = `
        <div class="paragraph">
          <div class="original">${textInput}</div>
          <div class="translation">AIæ­£åœ¨è§£æä¸­ï¼Œè¯·ç¨å€™...</div>
          <div class="notes">ã€è¯´æ˜ã€‘APIå“åº”æ ¼å¼å¼‚å¸¸ï¼Œæ˜¾ç¤ºåŸå§‹å›å¤</div>
        </div>
      `;

      // æ˜¾ç¤ºè§£æå†…å®¹
      analysisData = {
        'æ€æƒ³å†…æ¶µ': response,
        'æ–‡åŒ–èƒŒæ™¯': 'è¯·åœ¨èŠå¤©åŒºåŸŸè¯¢é—®æ›´å¤šè¯¦ç»†ä¿¡æ¯',
        'å…¸æ•…å…³è”': 'è¯·åœ¨èŠå¤©åŒºåŸŸè¯¢é—®æ›´å¤šè¯¦ç»†ä¿¡æ¯',
        'ç‰ˆæœ¬å¯¹æ¯”': 'è¯·åœ¨èŠå¤©åŒºåŸŸè¯¢é—®æ›´å¤šè¯¦ç»†ä¿¡æ¯'
      };

      applicationData = {
        'ç°å®æ¡ˆä¾‹': 'è¯·åœ¨èŠå¤©åŒºåŸŸè¯¢é—®ç°ä»£åº”ç”¨æ¡ˆä¾‹',
        'å¯ç¤ºå€Ÿé‰´': 'è¯·åœ¨èŠå¤©åŒºåŸŸè¯¢é—®å¯ç¤ºå€Ÿé‰´'
      };

      renderAnalysisSection();
      renderApplicationSection();

      // æ˜¾ç¤ºæ‰€æœ‰åŒºåŸŸ
      document.getElementById('originalSection').style.display = 'block';
      document.getElementById('analysisSection').style.display = 'block';
      document.getElementById('applicationSection').style.display = 'block';
    }

    // æ·»åŠ èŠå¤©æ¶ˆæ¯
    function addChatMessage(message, type) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type === 'user' ? 'user-message' : 'ai-message'}`;
      messageDiv.innerHTML = message.replace(/\n/g, '<br>');

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // è·å–èŠå¤©å†å²ï¼ˆæœ€è¿‘5æ¡æ¶ˆæ¯ï¼‰
    function getChatHistory() {
      const messages = document.querySelectorAll('.message');
      const history = [];

      // ä»æœ€å5æ¡æ¶ˆæ¯å¼€å§‹è·å–ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯ï¼‰
      const recentMessages = Array.from(messages).slice(-10).slice(1);

      recentMessages.forEach(msg => {
        if (msg.classList.contains('user-message')) {
          history.push({
            role: 'user',
            content: msg.textContent
          });
        } else if (msg.classList.contains('ai-message')) {
          history.push({
            role: 'assistant',
            content: msg.textContent
          });
        }
      });

      return history;
    }

    // ç¤ºä¾‹åŠŸèƒ½ï¼šå¿«é€Ÿä½“éªŒ
    function loadExample() {
      const exampleText = "å­æ›°ï¼š\"å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿæœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿäººä¸çŸ¥è€Œä¸æ„ ï¼Œä¸äº¦å›å­ä¹ï¼Ÿ\"";
      document.getElementById('textInput').value = exampleText;
    }

    // æ·»åŠ ç¤ºä¾‹æŒ‰é’®åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function () {
      // åœ¨è¾“å…¥åŒºåŸŸæ·»åŠ ç¤ºä¾‹æŒ‰é’®
      const inputActions = document.querySelector('.input-actions .file-upload');
      const exampleBtn = document.createElement('button');
      exampleBtn.className = 'upload-btn';
      exampleBtn.innerHTML = '<span>ğŸ“</span> åŠ è½½ç¤ºä¾‹';
      exampleBtn.onclick = loadExample;
      inputActions.appendChild(exampleBtn);
    });

    // é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–
    window.addEventListener('error', function (event) {
      console.error('å…¨å±€é”™è¯¯:', event.error);
    });

    // é˜²æ­¢è¡¨å•é»˜è®¤æäº¤
    document.addEventListener('DOMContentLoaded', function () {
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
        });
      });
    });
  </script>
</body>

</html>
